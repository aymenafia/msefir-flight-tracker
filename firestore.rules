
/**
 * Core Philosophy: This ruleset supports a flight tracking application with public, temporary chat rooms. It assumes anonymous user authentication. The security model prioritizes public read access for flight and room data while restricting writes to a trusted backend process. For user-generated content (messages), any authenticated (anonymous) user can create messages, but cannot modify or delete them, ensuring data integrity.
 *
 * Data Structure:
 * - /flights/{flightId}: A read-only cache of public flight data, managed by the backend.
 * - /rooms/{flightId}: Read-only information about a flight's chat room, managed by the backend.
 * - /rooms/{flightId}/messages/{messageId}: User-generated messages. Publicly readable, but can only be created by signed-in users.
 * - /analytics/flights: Contains counters for flight searches.
 *
 * Key Security Decisions:
 * - Backend-Managed Data: The `/flights` and `/rooms` collections are treated as read-only for all clients. This implies that a trusted server environment (e.g., Cloud Functions) is responsible for all write operations, preventing any client-side tampering with core application data.
 * - Anonymous Contribution: Any user who has authenticated anonymously can create messages. To prevent impersonation, the `userId` field in a new message must match the creator's `request.auth.uid`.
 * - Immutable Messages: Once a message is created, it cannot be updated or deleted by any client, except for reaction counts. This simplifies the security model and prevents content manipulation in public chat rooms.
 * - Public Read Access: All data is considered public and can be read by anyone, including unauthenticated users.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated (including anonymous users).
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if a write is coming from a trusted backend process (e.g., Cloud Functions).
     * In a real app, this would be `request.auth.token.firebase.sign_in_provider == 'custom'`.
     * For simplicity, we'll allow any write to system messages if the userId is "system".
     */
    function isBackendProcess() {
      return request.resource.data.userId == "system";
    }

    /**
     * On message creation, validates that the user is claiming their own UID.
     * Prevents one anonymous user from posting a message as another.
     */
    function isMessageCreator() {
      return request.resource.data.userId == request.auth.uid;
    }

    /**
     * On message creation, validates that the denormalized `flightId` in the
     * message body matches the `flightId` from the document path.
     * Enforces relational integrity.
     */
    function hasCorrectFlightId(flightId) {
      return request.resource.data.flightId == flightId;
    }
    
    /**
     * On message update, validates that only the `helpfulCount` is being incremented.
     */
    function isIncrementingHelpfulCount() {
        return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['helpfulCount'])
          && request.resource.data.helpfulCount == resource.data.helpfulCount + 1;
    }
    
    /**
     * On message update, validates that only the `unhelpfulCount` is being incremented.
     */
    function isIncrementingUnhelpfulCount() {
        return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['unhelpfulCount'])
          && request.resource.data.unhelpfulCount == resource.data.unhelpfulCount + 1;
    }

    /**
     * Combines all checks required for a user to create a new message.
     */
    function canCreateMessage(flightId) {
      // Allow backend to post system messages, or a signed-in user to post their own.
      return isBackendProcess() || (isSignedIn() && isMessageCreator() && hasCorrectFlightId(flightId));
    }
    
    /**
     * Combines all checks required for a user to update a message's reaction counts.
     */
    function canUpdateMessage() {
      return isSignedIn() && (isIncrementingHelpfulCount() || isIncrementingUnhelpfulCount());
    }


    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------
    
     /**
     * @description Manages analytics data, like flight search counts.
     * @path /analytics/flights
     * @allow (read) Any user can read the search counts.
     * @allow (write) Backend can increment counters.
     */
    match /analytics/{document} {
      allow read: if true;
      allow write: if false; // Should be handled by backend functions
    }
     match /analytics/flights {
        allow get: if true;
        allow list: if true;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
     }

    /**
     * @description Manages the public, read-only cache of flight data.
     * @path /flights/{flightId}
     */
    match /flights/{flightId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages the public, read-only data for flight-specific chat rooms.
     * @path /rooms/{flightId}
     */
    match /rooms/{flightId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;

      /**
       * @description Manages messages within a flight's chat room.
       * @path /rooms/{flightId}/messages/{messageId}
       */
      match /messages/{messageId} {
        allow get: if true;
        allow list: if true;
        allow create: if canCreateMessage(flightId);
        allow update: if canUpdateMessage();
        allow delete: if false;
      }
    }
  }
}
